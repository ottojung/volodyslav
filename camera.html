<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Instant Photo Shooter</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <style>
      html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
      }
      body {
          display: flex;
          flex-direction: column;
          font-family: sans-serif;
          background: #000;
          color: #fff;
      }
      .screen {
          position: relative;
          flex: 1;
          width: 100%;
          overflow: hidden;
      }
      video, canvas {
          width: 100%;
          height: 100%;
          object-fit: cover;
          background: #000;
      }

      /* generic absolutely-centered control bar */
      .controls {
          position: absolute;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          display: flex;
          gap: 0.5em;
          padding: 0 0.5em;
          box-sizing: border-box;
          flex-wrap: wrap;
      }

      /* override .btn positioning inside any .controls */
      .controls .btn {
          position: static;
          margin: 0;
          transform: none;
      }

      /* original .btn styling */
      .btn {
          padding: 0.8em 1.6em;
          font-size: 1rem;
          border: none;
          border-radius: 5px;
          background: rgba(255,255,255,0.2);
          color: #fff;
      }
    </style>
  </head>
  <body>

    <!-- CAMERA SCREEN -->
    <div id="camera-screen" class="screen">
      <video id="video" autoplay playsinline></video>

      <!-- camera controls: Take + Done -->
      <div id="camera-controls" class="controls">
        <button id="take-btn" class="btn">Take Photo</button>
        <button id="done-btn" class="btn" style="display:none">Done</button>
      </div>
    </div>

    <!-- PREVIEW SCREEN -->
    <div id="preview-screen" class="screen" style="display:none">
      <canvas id="canvas"></canvas>

      <!-- preview controls: Redo + More -->
      <div id="preview-controls" class="controls">
        <button id="redo-btn" class="btn">Redo</button>
        <button id="more-btn" class="btn">More</button>
        <button id="done-btn-2" class="btn">Done</button>
      </div>
    </div>

    <!-- JSZip for zipping up the photos -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js"></script>
    <script>
      (function(){
          // → 0) pull “name” out of ?name=foo-bar (or default to “photos”).
          const params    = new URLSearchParams(window.location.search);
          const baseName  = params.get('name')?.trim() || 'photos';
          const zipName   = baseName + '.zip';

          const video        = document.getElementById('video');
          const takeBtn      = document.getElementById('take-btn');
          const cameraScr    = document.getElementById('camera-screen');
          const previewScr   = document.getElementById('preview-screen');
          const canvas       = document.getElementById('canvas');
          const moreBtn      = document.getElementById('more-btn');
          const redoBtn      = document.getElementById('redo-btn');
          const doneBtn      = document.getElementById('done-btn');
          const doneBtn2     = document.getElementById('done-btn-2');
          const ctx          = canvas.getContext('2d');

          let currentBlob = null;
          const photos = [];  // { blob, name }

          function add_last_photo() {
              if (currentBlob) {
                  const idx = photos.length + 1;
                  const index = String(idx).padStart(2, '0');
                  photos.push({
                      blob: currentBlob,
                      name: `photo_${index}.jpg`,
                  });
                  currentBlob = null;
              }
          }

          // 1) Start back‐facing camera
          navigator.mediaDevices.getUserMedia({
              video: {
                  facingMode: { ideal: "environment" },
                  width:  { ideal: 1920 },  // ask for 1080p HD
                  height: { ideal: 1080 }
              },
              audio: false
          })
              .then(stream => {
                  video.srcObject = stream;
                  video.play();
              })
              .catch(err => {
                  alert("Error accessing camera: " + err);
              });

          // 2) Take Photo
          takeBtn.addEventListener('click', () => {
              canvas.width  = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              canvas.toBlob(b => {
                  currentBlob = b;
              }, 'image/jpeg', 1.0);

              doneBtn.style.display = 'block';
              cameraScr.style.display  = 'none';
              previewScr.style.display = 'block';
          });

          // 3a) More → store and go back to camera
          moreBtn.addEventListener('click', () => {
              add_last_photo();
              previewScr.style.display = 'none';
              cameraScr.style.display  = 'block';
          });

          // 3b) Redo → discard and back to camera
          redoBtn.addEventListener('click', () => {
              currentBlob = null;
              previewScr.style.display = 'none';
              cameraScr.style.display  = 'block';
          });

          // 3c) Done → zip & download immediately
          function zipAndDownload() {
              add_last_photo();

              if (photos.length === 0) {
                  alert("No photos to download.");
                  return;
              }

              previewScr.style.display = 'none';
              cameraScr.style.display  = 'none';

              // Build ZIP
              const zip = new JSZip();
              photos.forEach(p => zip.file(p.name, p.blob));
              zip.generateAsync({ type: 'blob' })
                  .then(zblob => {
                      // trigger immediate download
                      const url = URL.createObjectURL(zblob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = zipName;
                      document.body.appendChild(a);
                      a.click();
                      setTimeout(() => {
                          URL.revokeObjectURL(url);
                          a.remove();
                      }, 1000);
                  });
          }

          doneBtn.addEventListener('click', zipAndDownload);
          doneBtn2.addEventListener('click', zipAndDownload);
      })();
    </script>
  </body>
</html>
